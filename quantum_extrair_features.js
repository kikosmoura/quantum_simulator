var aoi = 
    /* color: #d63000 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[-53.347193006860635, -29.163190244929527],
          [-53.347193006860635, -29.239311585909224],
          [-53.21226716457548, -29.239311585909224],
          [-53.21226716457548, -29.163190244929527]]], null, false),
    mapbiomas_rs = ee.Image("projects/ee-kikosmoura/assets/mapbiomas_rs_uf"),
    aoi_predicao = 
    /* color: #98ff00 */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[-53.285292321534556, -29.190192603412708],
          [-53.285292321534556, -29.194641515400996],
          [-53.27718132147352, -29.194641515400996],
          [-53.27718132147352, -29.190192603412708]]], null, false),
    soja = 
    /* color: #ffc82d */
    /* shown: false */
    ee.Geometry.MultiPoint(
        [[-53.281732788657386, -29.180350816946284],
         [-53.280535870147084, -29.194344818830196],
         [-53.274373006439724, -29.206463868611113],
         [-53.27070747213817, -29.200476406587025],
         [-53.277544221005186, -29.18513846904255],
         [-53.28177138241266, -29.19177721165419],
         [-53.27963520871739, -29.193929661325935],
         [-53.27984978543858, -29.1945852786948],
         [-53.2803218542252, -29.194697669822872],
         [-53.2803218542252, -29.195634257766073],
         [-53.27330519544224, -29.195652989437683],
         [-53.27358414517979, -29.19570918443198],
         [-53.28075100766758, -29.193405164412788],
         [-53.27832629071812, -29.19108236012247],
         [-53.277403610817, -29.19104489510602],
         [-53.27934378843534, -29.18988065990273],
         [-53.28109258871305, -29.190564402060527],
         [-53.281511013319374, -29.190227214716778],
         [-53.28177923422086, -29.190976518419617],
         [-53.28235859136808, -29.191163843489928],
         [-53.28228348951566, -29.192278420583655],
         [-53.281747047712685, -29.193018343224523],
         [-53.28102821569669, -29.19382248547744],
         [-53.28029865484464, -29.19389741346719],
         [-53.28304523687589, -29.19171511334207],
         [-53.281478826811195, -29.19220215430551],
         [-53.28112477522123, -29.19122807006558],
         [-53.27832454900968, -29.189640593505082],
         [-53.27810997228849, -29.190277505644488],
         [-53.27894682150114, -29.188938112293798],
         [-53.280996029188515, -29.18945326565254],
         [-53.28055614691007, -29.18999651548232],
         [-53.278485481550575, -29.188329291352126],
         [-53.27961200933683, -29.1888069819348],
         [-53.27968711118925, -29.19047419829995],
         [-53.27878588896024, -29.19017447600776],
         [-53.27754134397733, -29.190108911639573],
         [-53.27814215879667, -29.188938112293798],
         [-53.27936524610746, -29.189247204619537],
         [-53.28037375669706, -29.188750783158195],
         [-53.28106040220487, -29.188835081311556],
         [-53.27510589819181, -29.18684937307143],
         [-53.27514881353605, -29.18729897075657],
         [-53.27469820242155, -29.18717720491142],
         [-53.27479476194608, -29.18805766238152],
         [-53.27488059263456, -29.187505035703634],
         [-53.27437633733976, -29.18795463051486],
         [-53.27370351718982, -29.19586817984991],
         [-53.27257698940357, -29.195849448217622],
         [-53.27309197353443, -29.196392664164826],
         [-53.27348894046863, -29.19680475710159],
         [-53.27250188755115, -29.19727304251928],
         [-53.27127880024036, -29.195943106344878],
         [-53.27079600261768, -29.196814122830897],
         [-53.28000380287438, -29.196092959170517],
         [-53.28040076980859, -29.19659871084023],
         [-53.28029348144799, -29.197469721756935],
         [-53.28027202377587, -29.197816250924333],
         [-53.27990724334985, -29.19760084103909],
         [-53.27403857002526, -29.197141922817913],
         [-53.27456428299218, -29.197872444733015],
         [-53.2741351295498, -29.198556133604995],
         [-53.273630874255, -29.197479087425506],
         [-53.27212883720666, -29.19640202993178],
         [-53.27158166656762, -29.19530622939256],
         [-53.27086283455163, -29.194894130433152],
         [-53.27030493507653, -29.194613152920358],
         [-53.270208375551995, -29.19540925387362],
         [-53.27050878296166, -29.195765155829953],
         [-53.27152802238732, -29.196767294175782],
         [-53.272740380862054, -29.196748562707736],
         [-53.2731266189602, -29.19773196015357],
         [-53.27407075653344, -29.198012929119948],
         [-53.27440335045129, -29.199136797285693],
         [-53.28205103460494, -29.19003728866069],
         [-53.28212613645736, -29.18874472451304],
         [-53.28264112058822, -29.188323232682077],
         [-53.28173989835921, -29.18834196568913],
         [-53.28077430311385, -29.187845539846418],
         [-53.279948182737265, -29.18796730489814],
         [-53.27758783880416, -29.18795793836083],
         [-53.27904696050826, -29.18671218127685],
         [-53.27848906103316, -29.18640308131176],
         [-53.278671451246176, -29.186852680953066],
         [-53.27727670255843, -29.187189879390786],
         [-53.277459092771444, -29.189615802141535],
         [-53.2771264988536, -29.19013095209637],
         [-53.277212329542074, -29.19052433759219],
         [-53.27661151472274, -29.19061800058309],
         [-53.27856416288558, -29.19046813975661],
         [-53.278961129819784, -29.190683564625825],
         [-53.28264485768533, -29.1907899615347],
         [-53.282934536258935, -29.191998204422166],
         [-53.28376065663552, -29.191951373567683],
         [-53.281530144210045, -29.193441950701356],
         [-53.28091860055465, -29.194500307409285],
         [-53.2831072831108, -29.190894357020866],
         [-53.28217387437362, -29.19021998339441],
         [-53.281530144210045, -29.189695467508127],
         [-53.280285599227135, -29.19029491401631]]),
    floresta = 
    /* color: #00ffff */
    /* shown: false */
    ee.Geometry.MultiPoint(
        [[-53.27887206362233, -29.192412281446632],
         [-53.278013756737565, -29.193311426075226],
         [-53.27701315069794, -29.192007922164112],
         [-53.2780860343039, -29.19438690120917],
         [-53.274395314699404, -29.19416211814861],
         [-53.27450260306, -29.194855197669366],
         [-53.27469572210907, -29.1953234919909],
         [-53.27370866919159, -29.194649147490377],
         [-53.278107491976016, -29.195229833297688],
         [-53.28016742849945, -29.19230763909804],
         [-53.27754959250092, -29.19227017452921],
         [-53.275661317354434, -29.191445950552016],
         [-53.276390878206485, -29.192101583800063],
         [-53.27422365332245, -29.191221161044925],
         [-53.27787267127445, -29.191741953774795],
         [-53.278022874979285, -29.19202293915477],
         [-53.27789412894657, -29.192584907605074],
         [-53.277261127619056, -29.192837792402997],
         [-53.27737914481571, -29.19326863173359],
         [-53.27742206015995, -29.193793129345046],
         [-53.276778329996375, -29.192650470390337],
         [-53.27673541465214, -29.19224772690442],
         [-53.2767461434882, -29.191816883284737],
         [-53.27592002311161, -29.191760686157412],
         [-53.27410684981754, -29.193718201279097],
         [-53.27416049399784, -29.194186500793148],
         [-53.27442871489933, -29.194439381641484],
         [-53.27394591727665, -29.19485148242848],
         [-53.27349530616215, -29.194982605058833],
         [-53.2736669675391, -29.193999181244152],
         [-53.27437507071903, -29.19363390713944],
         [-53.277250398782996, -29.19423333062693],
         [-53.27738987365177, -29.19469226186621],
         [-53.277819027094154, -29.194832750610434],
         [-53.277754654077796, -29.19404601116348],
         [-53.277540077356605, -29.19280969412291],
         [-53.278258909372596, -29.192200896163886],
         [-53.278312553552894, -29.193652639176445],
         [-53.27817307868412, -29.192847158494647],
         [-53.274804224161414, -29.194383185951303],
         [-53.27543246109149, -29.189883688219517],
         [-53.27545391876361, -29.190295807313948],
         [-53.27414500076434, -29.189874321857225],
         [-53.27440249282977, -29.190342638924438],
         [-53.272557133027526, -29.190099114316375],
         [-53.27286826927325, -29.19056743035713],
         [-53.27352272827289, -29.190839052680925],
         [-53.2731472190108, -29.190230243023343],
         [-53.273340338059874, -29.189996084500418],
         [-53.272814625092956, -29.189761925442877],
         [-53.2716344531264, -29.189630796137138],
         [-53.271849029847594, -29.18998671814838],
         [-53.27291118461749, -29.191101308035087],
         [-53.27100541173067, -29.193627150256138],
         [-53.27204610882845, -29.194123548113787],
         [-53.272400160418414, -29.19431086743559],
         [-53.27255036412325, -29.194545016106645],
         [-53.27257182179537, -29.194769798327844],
         [-53.274116774187945, -29.194854091533752],
         [-53.27427770672884, -29.19557526390742],
         [-53.27494289456453, -29.195650190616423],
         [-53.2787730890378, -29.195022677737693],
         [-53.278837462054156, -29.195884336229145],
         [-53.277861137972735, -29.195453507888516],
         [-53.278217260649086, -29.19589699201555],
         [-53.278270904829384, -29.19638401311721],
         [-53.27944034795988, -29.196543231052566],
         [-53.27963346700895, -29.19673991169016],
         [-53.27938670377958, -29.195616017250778],
         [-53.27883953314054, -29.196515133787823],
         [-53.2788502619766, -29.19707707761973],
         [-53.27830309133756, -29.197002151953424],
         [-53.27783102255094, -29.196103039687024],
         [-53.27791685323942, -29.196543231052566],
         [-53.277981226255775, -29.19682420327649],
         [-53.2784532950424, -29.197320585657092],
         [-53.278753702452065, -29.197517264803537],
         [-53.275470678617836, -29.19617796601037],
         [-53.27544922094572, -29.19656196255811],
         [-53.27563161115873, -29.196955323384167],
         [-53.277476970960976, -29.19617796601037],
         [-53.27764863233793, -29.19687103190563],
         [-53.27813142996061, -29.197535996131155],
         [-53.278528396894814, -29.197835696907397],
         [-53.27588910322416, -29.197461070800202],
         [-53.27603930692899, -29.197948084472653],
         [-53.27288502912748, -29.19433288937214],
         [-53.27165121298063, -29.19438908508988],
         [-53.27165121298063, -29.19383649252787],
         [-53.27518100004423, -29.190522253703186],
         [-53.27515954237211, -29.190943736497136],
         [-53.279751484205605, -29.191468245999424],
         [-53.279708568861366, -29.19218007603323],
         [-53.279740755369545, -29.192610918127073],
         [-53.279461805631996, -29.19269521310762],
         [-53.279215042402626, -29.19162747156756],
         [-53.27932233076322, -29.192030217489336],
         [-53.279955332090736, -29.191636837769757],
         [-53.28018063764799, -29.191721133550974],
         [-53.28035229902494, -29.192507890834516]]),
    aoi_predicao_v2 = 
    /* color: #d63000 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[-53.27826312351517, -29.199525246501356],
          [-53.27826312351517, -29.200396232555875],
          [-53.27576330471329, -29.200396232555875],
          [-53.27576330471329, -29.199525246501356]]], null, false),
    geometry = /* color: #d63000 */ee.Geometry.MultiPoint();

// Função para converter um MultiPoint em FeatureCollection com atributo 'classe'
function multipointToFC(multipoint, classValue) {
  var coords = multipoint.coordinates();
  var features = coords.map(function(coord) {
    return ee.Feature(ee.Geometry.Point(coord), {'classe': classValue});
  });
  return ee.FeatureCollection(features);
}

// Converter cada conjunto de pontos para FeatureCollection
//var riosFC = multipointToFC(rios, 1);
var sojaFC = multipointToFC(soja, 1);
var florestaFC = multipointToFC(floresta, 2);

// Unir os pontos de treinamento
//var trainingPoints = riosFC.merge(sojaFC).merge(florestaFC);
var trainingPoints = sojaFC.merge(florestaFC);

// Função para máscara de nuvens e normalização no Sentinel-2
function maskS2(image) {
  var qa = image.select('QA60');
  var cloudBitMask = 1 << 10;
  var cirrusBitMask = 1 << 11;
  var mask = qa.bitwiseAnd(cloudBitMask).eq(0)
              .and(qa.bitwiseAnd(cirrusBitMask).eq(0));
  return image.updateMask(mask)
              .divide(10000)
              .copyProperties(image, ['system:time_start']);
}

// Definir a coleção Sentinel-2 para 2020
var s2 = ee.ImageCollection('COPERNICUS/S2_SR')
  .filterBounds(aoi)
  .filterDate('2020-01-01', '2020-12-31')
  .map(maskS2);

// Criar um composite mediano e limitar à área de treinamento
var composite = s2.median().clip(aoi);

// Calcular a média do NDVI para o ano (NDVI = (B8 - B4) / (B8 + B4))
var ndvi_mean = s2.map(function(image) {
  return image.normalizedDifference(['B8', 'B4']).rename('NDVI');
}).mean().clip(aoi);

// Adicionar a banda NDVI ao composite
var compositeWithNDVI = composite.addBands(ndvi_mean);

// Definir as bandas preditivas (incluindo o NDVI)
var bands = ['B2', 'B3', 'B4', 'B8', 'NDVI'];

// Amostrar os pixels do composite com NDVI usando os pontos de treinamento
var training = compositeWithNDVI.select(bands).sampleRegions({
  collection: trainingPoints,
  properties: ['classe'],
  scale: 10
});

// Selecionar as bandas e o atributo 'classe'
var trainingExport = training.select(['B2', 'B3', 'B4', 'B8', 'NDVI', 'classe']);

// Exportar os dados de treinamento como CSV para o Google Drive
Export.table.toDrive({
  collection: trainingExport,
  description: 'Training_Features',
  fileFormat: 'CSV'
});

// Amostrar os pixels do composite com NDVI dentro da área de predição
var predictionSamples = compositeWithNDVI.select(bands).sample({
  region: aoi_predicao,
  scale: 10,
  numPixels: 1e6,      // Ajuste para garantir cobertura total (cuidado com o tamanho do arquivo)
  geometries: true
});

// Exportar os dados de predição como CSV para o Google Drive
Export.table.toDrive({
  collection: predictionSamples,
  description: 'Prediction_Features',
  fileFormat: 'CSV'
});
